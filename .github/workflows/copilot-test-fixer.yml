name: Copilot Test Fixer

# Triggers when Playwright Tests workflow completes with failure
on:
    workflow_run:
        workflows: ["Playwright Tests"]
        types: [completed]

permissions:
    contents: write
    issues: write
    pull-requests: write
    actions: read

jobs:
    investigate-and-fix:
        # Only run if Playwright Tests failed
        if: ${{ github.event.workflow_run.conclusion == 'failure' }}
        runs-on: ubuntu-latest
        timeout-minutes: 20

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.workflow_run.head_branch }}
                  fetch-depth: 10

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install dependencies
              run: npm ci

            - name: Install GitHub Copilot CLI
              run: |
                  echo "Installing GitHub Copilot CLI from npm..."
                  npm i -g @github/copilot
                  copilot --version

            - name: Download Playwright test results
              uses: actions/download-artifact@v4
              with:
                  name: playwright-report-docker
                  path: test-results/
                  run-id: ${{ github.event.workflow_run.id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}
              continue-on-error: true

            - name: Extract test failure details
              id: extract-failures
              run: |
                  echo "## Test Failure Analysis" > failure-summary.md
                  echo "" >> failure-summary.md
                  echo "**Workflow Run:** ${{ github.event.workflow_run.html_url }}" >> failure-summary.md
                  echo "**Branch:** ${{ github.event.workflow_run.head_branch }}" >> failure-summary.md
                  echo "**Commit:** ${{ github.event.workflow_run.head_sha }}" >> failure-summary.md
                  echo "" >> failure-summary.md

                  # Try to extract failed test names from directory structure
                  if [ -d "test-results" ]; then
                    echo "**Failed Tests:**" >> failure-summary.md
                    find test-results -type d -name "*-failed" | head -10 | while read dir; do
                      testname=$(basename "$dir" | sed 's/-failed$//')
                      echo "- $testname" >> failure-summary.md
                    done
                  else
                    echo "- Unable to download test results" >> failure-summary.md
                  fi

                  cat failure-summary.md

            - name: Get recent commits
              id: recent-commits
              run: |
                  echo "## Recent Commits" > recent-commits.md
                  git log --oneline -5 >> recent-commits.md
                  cat recent-commits.md

            - name: Configure Copilot CLI Authentication
              env:
                  COPILOT_CLI_TOKEN: ${{ secrets.COPILOT_CLI_TOKEN }}
              run: |
                  # Create config directory
                  mkdir -p ~/.copilot

                  # Configure authentication (token will be used via env var)
                  echo "‚úÖ Copilot CLI authentication configured"

            - name: Configure Atlassian MCP Server
              env:
                  ATLASSIAN_API_TOKEN: ${{ secrets.COPILOT_MCP_ATLASSIAN_API_TOKEN }}
                  ATLASSIAN_EMAIL: ${{ secrets.COPILOT_MCP_ATLASSIAN_EMAIL }}
                  ATLASSIAN_DOMAIN: ${{ secrets.COPILOT_MCP_ATLASSIAN_DOMAIN }}
              run: |
                  # Create MCP configuration for Atlassian (using @sooperset/mcp-atlassian)
                  cat > ~/.copilot/mcp-config.json <<'EOF'
                  {
                    "mcpServers": {
                      "atlassian": {
                        "command": "npx",
                        "args": ["-y", "@sooperset/mcp-atlassian"],
                        "env": {
                          "ATLASSIAN_DOMAIN": "$ATLASSIAN_DOMAIN",
                          "ATLASSIAN_EMAIL": "$ATLASSIAN_EMAIL",
                          "ATLASSIAN_API_TOKEN": "$ATLASSIAN_API_TOKEN"
                        }
                      }
                    }
                  }
                  EOF

                  # Replace placeholders with actual secrets
                  sed -i "s/\$ATLASSIAN_DOMAIN/${{ env.ATLASSIAN_DOMAIN }}/g" ~/.copilot/mcp-config.json
                  sed -i "s/\$ATLASSIAN_EMAIL/${{ env.ATLASSIAN_EMAIL }}/g" ~/.copilot/mcp-config.json
                  sed -i "s/\$ATLASSIAN_API_TOKEN/${{ env.ATLASSIAN_API_TOKEN }}/g" ~/.copilot/mcp-config.json

                  echo "‚úÖ Atlassian MCP server configured (@sooperset/mcp-atlassian)"

            - name: Trust repository directory
              run: |
                  # Configure trusted directories
                  mkdir -p ~/.copilot/trusted
                  echo "${{ github.workspace }}" > ~/.copilot/trusted/dirs.txt
                  echo "‚úÖ Repository directory trusted"

            - name: Run Copilot Test Fixer Agent
              id: copilot-investigation
              env:
                  COPILOT_CLI_TOKEN: ${{ secrets.COPILOT_CLI_TOKEN }}
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
                  JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
              run: |
                  # Create investigation prompt
                  cat > investigation-prompt.txt <<'PROMPT'
                  You are investigating a Playwright test failure. Here is the context:

                  PROMPT

                  cat failure-summary.md >> investigation-prompt.txt
                  cat recent-commits.md >> investigation-prompt.txt

                  cat >> investigation-prompt.txt <<'PROMPT'

                  Your tasks:
                  1. Analyze why the Playwright tests failed
                  2. Review recent commits to identify UI changes
                  3. Fix the test code (NOT application code) to match the new UI
                  4. Create a Jira Sub-task under GHC-1392 with details
                  5. Create a GitHub issue linked to the Jira ticket
                  6. Use /delegate to create a PR with the test fix

                  Focus on simple fixes like text assertions or selector updates.
                  Be thorough but pragmatic. Include all relevant file paths.
                  PROMPT

                  echo "üìã Investigation Prompt created"

                  # Run Copilot CLI investigation with agent
                  echo "Running Copilot analysis with test-fixer agent..."

                  # Construct the full prompt with agent definition and context
                  AGENT_PROMPT=$(cat .github/agents/test-fixer.md)
                  FULL_PROMPT="$AGENT_PROMPT"
                  FULL_PROMPT+=$'\n\nContext:\n'
                  FULL_PROMPT+="$(cat investigation-prompt.txt)"

                  # Execute Copilot with agent (non-interactive mode)
                  echo "$FULL_PROMPT" | copilot --prompt "$(cat -)" --allow-all-tools --allow-all-paths < /dev/null \
                          > copilot-output.log 2>&1 || true

                  echo "üìÑ Copilot Analysis:"
                  cat copilot-output.log

                  # Parse Copilot output for fix recommendations
                  echo "Extracting recommendations..."
                  grep -A 20 "Recommendation\|Fix\|Solution" copilot-output.log > recommendations.txt || echo "No specific recommendations found" > recommendations.txt

            - name: Upload investigation artifacts
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: copilot-investigation
                  path: |
                      copilot-output.log
                      failure-summary.md
                      recent-commits.md
                      test-results/
                  retention-days: 30

            - name: Comment on failed workflow
              if: always()
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      let output = 'No output available';
                      try {
                        output = fs.readFileSync('copilot-output.log', 'utf8');
                      } catch (e) {
                        output = 'Could not read Copilot output';
                      }

                      const comment = `## ü§ñ Copilot Test Fixer Investigation

                      The Playwright test failure has been analyzed by Copilot CLI.

                      **Workflow Run:** ${{ github.event.workflow_run.html_url }}
                      **Branch:** ${{ github.event.workflow_run.head_branch }}
                      **Commit:** ${{ github.event.workflow_run.head_sha }}

                      <details>
                      <summary>üìã Investigation Output</summary>

                      \`\`\`
                      ${output.substring(0, 5000)}
                      \`\`\`

                      </details>

                      Check the [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for complete logs.
                      `;

                      // Comment on the commit that triggered the failure
                      github.rest.repos.createCommitComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        commit_sha: '${{ github.event.workflow_run.head_sha }}',
                        body: comment
                      });

            - name: Create GitHub Issue with Copilot Agent Instructions
              uses: actions/github-script@v7
              env:
                  WORKFLOW_URL: ${{ github.event.workflow_run.html_url }}
                  BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}
                  COMMIT_SHA: ${{ github.event.workflow_run.head_sha }}
                  REPO_NAME: ${{ github.repository }}
                  RUN_ID: ${{ github.run_id }}
              with:
                  script: |
                      const fs = require('fs');

                      // Read investigation output
                      let copilotAnalysis = 'Investigation output not available';
                      try {
                        copilotAnalysis = fs.readFileSync('copilot-output.log', 'utf8');
                      } catch (e) {}

                      // Read recommendations
                      let recommendations = 'No recommendations extracted';
                      try {
                        recommendations = fs.readFileSync('recommendations.txt', 'utf8');
                      } catch (e) {}

                      // Create GitHub issue
                      const issue = await github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: `üêõ Playwright Test Failure: ${new Date().toISOString().split('T')[0]}`,
                        body: `## üî¥ Playwright Test Suite Failed

                      **Workflow Run:** ${process.env.WORKFLOW_URL}
                      **Branch:** \`${process.env.BRANCH_NAME}\`
                      **Commit:** \`${process.env.COMMIT_SHA}\`
                      **Failed Job:** Playwright E2E Tests

                      ### ü§ñ AI Analysis

                      <details>
                      <summary>Copilot Investigation Results</summary>

                      \`\`\`
                      ${copilotAnalysis.substring(0, 3000)}
                      \`\`\`

                      </details>

                      ### üìã Recommendations

                      \`\`\`
                      ${recommendations}
                      \`\`\`

                      ---

                      ### üöÄ Next Steps for Developer

                      **Option 1: Use GitHub Copilot Coding Agent (Recommended)**

                      1. Open this repository in VS Code with GitHub Copilot enabled
                      2. Open Copilot Chat (Cmd/Ctrl + I)
                      3. Mention this issue: \`Fix the test failure in #\${issue.data.number}\`
                      4. Add the coding agent hashtag: \`#github-pull-request_copilot-coding-agent\`
                      5. Copilot will create a branch and PR with the fix

                      **Example prompt:**
                      \`\`\`
                      Fix the Playwright test failure described in issue #\${issue.data.number}. 
                      Analyze the test expectations and update the code or tests as appropriate.
                      #github-pull-request_copilot-coding-agent
                      \`\`\`

                      **Option 2: Manual Fix**

                      1. Review the Copilot analysis above
                      2. Check [workflow artifacts](https://github.com/${process.env.REPO_NAME}/actions/runs/${process.env.RUN_ID})
                      3. Create a branch and fix the issue
                      4. Link this issue in your PR

                      ---

                      _ü§ñ This issue was auto-generated by the Copilot Test Fixer workflow_

                      **Related Jira:** GHC-1392`,
                        labels: ['bug', 'testing', 'automated', 'copilot-agent']
                      });

                      console.log(`Created issue #${issue.data.number}`);

                      // Assign Copilot bot using REST API with custom agent
                      try {
                        await github.rest.issues.addAssignees({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issue.data.number,
                          assignees: ['copilot-swe-agent[bot]'],
                          agent_assignment: {
                            target_repo: `${context.repo.owner}/${context.repo.repo}`,
                            base_branch: 'main',
                            custom_instructions: `Fix the Playwright test failure. Check the investigation results in issue #${issue.data.number} for context.`,
                            custom_agent: 'test-fixer',
                            model: ''
                          }
                        });
                        
                        console.log(`‚úÖ Assigned issue #${issue.data.number} to Copilot bot with test-fixer agent`);
                      } catch (error) {
                        console.log(`‚ö†Ô∏è Could not auto-assign to Copilot: ${error.message}`);
                        console.log('Issue can be manually assigned via GitHub UI');
                      }
            - name: Create JIRA subtask
              if: success()
              env:
                  JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
                  JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
              run: |
                  # Get the GitHub issue number from previous step
                  ISSUE_NUMBER=$(gh issue list --repo ${{ github.repository }} --label "automated" --limit 1 --json number --jq '.[0].number')
                  ISSUE_URL="https://github.com/${{ github.repository }}/issues/${ISSUE_NUMBER}"

                  echo "Creating JIRA subtask for issue #${ISSUE_NUMBER}..."

                  # Create JIRA subtask under GHC-1392
                  JIRA_RESPONSE=$(curl -X POST \
                    -H "Content-Type: application/json" \
                    -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
                    "https://moduscreate.atlassian.net/rest/api/3/issue" \
                    -d "{
                      \"fields\": {
                        \"project\": {\"key\": \"GHC\"},
                        \"parent\": {\"key\": \"GHC-1392\"},
                        \"issuetype\": {\"name\": \"Subtask\"},
                        \"summary\": \"[Automated] Playwright test failure investigation\",
                        \"description\": {
                          \"type\": \"doc\",
                          \"version\": 1,
                          \"content\": [
                            {
                              \"type\": \"paragraph\",
                              \"content\": [
                                {\"type\": \"text\", \"text\": \"Automated test failure detected and under investigation by Copilot bot.\\n\\n\"}
                              ]
                            },
                            {
                              \"type\": \"paragraph\",
                              \"content\": [
                                {\"type\": \"text\", \"text\": \"GitHub Issue: \", \"marks\": [{\"type\": \"strong\"}]},
                                {\"type\": \"text\", \"text\": \"${ISSUE_URL}\", \"marks\": [{\"type\": \"link\", \"attrs\": {\"href\": \"${ISSUE_URL}\"}}]}
                              ]
                            },
                            {
                              \"type\": \"paragraph\",
                              \"content\": [
                                {\"type\": \"text\", \"text\": \"Workflow Run: \", \"marks\": [{\"type\": \"strong\"}]},
                                {\"type\": \"text\", \"text\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\", \"marks\": [{\"type\": \"link\", \"attrs\": {\"href\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}}]}
                              ]
                            },
                            {
                              \"type\": \"paragraph\",
                              \"content\": [
                                {\"type\": \"text\", \"text\": \"Status: Waiting for Copilot bot to create fix PR\"}
                              ]
                            }
                          ]
                        }
                      }
                    }")

                  JIRA_KEY=$(echo "$JIRA_RESPONSE" | jq -r '.key')
                  JIRA_URL="https://moduscreate.atlassian.net/browse/${JIRA_KEY}"

                  echo "‚úÖ Created JIRA subtask: ${JIRA_KEY}"
                  echo "üîó ${JIRA_URL}"

                  # Add JIRA link to GitHub issue
                  gh issue comment ${ISSUE_NUMBER} --repo ${{ github.repository }} --body "üìã **JIRA Ticket Created:** [${JIRA_KEY}](${JIRA_URL})"
