name: Test Copilot Setup (Manual)

# Manual trigger only - for testing the Copilot workflow components
on:
  workflow_dispatch:
    inputs:
      test_prompt:
        description: 'Test prompt for Copilot'
        required: false
        default: 'Analyze this repository structure and list the main components.'

jobs:
  test-copilot-components:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Test - Install Copilot CLI
        run: |
          echo "ğŸ”§ Installing @github/copilot from npm..."
          npm i -g @github/copilot
          echo "âœ… Installation complete"
          
      - name: Test - Verify Copilot CLI
        run: |
          echo "ğŸ“‹ Checking Copilot CLI version..."
          copilot --version || echo "âŒ copilot command not found"
          
          echo "ğŸ“‹ Checking npm global packages..."
          npm list -g --depth=0 | grep copilot || echo "âš ï¸ @github/copilot not in global packages"
          
      - name: Test - Check Agent File
        run: |
          echo "ğŸ“„ Checking if agent file exists..."
          if [ -f ".github/agents/test-fixer.md" ]; then
            echo "âœ… Agent file found"
            echo "ğŸ“ Agent file size: $(wc -l < .github/agents/test-fixer.md) lines"
            head -20 .github/agents/test-fixer.md
          else
            echo "âŒ Agent file not found"
            exit 1
          fi
          
      - name: Test - MCP Configuration
        env:
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
        run: |
          echo "ğŸ”§ Creating MCP configuration..."
          
          mkdir -p ~/.copilot
          
          # Check if secrets are configured
          if [ -z "$JIRA_API_TOKEN" ]; then
            echo "âš ï¸ JIRA_API_TOKEN not configured (optional)"
          else
            echo "âœ… JIRA_API_TOKEN configured"
          fi
          
          if [ -z "$JIRA_USER_EMAIL" ]; then
            echo "âš ï¸ JIRA_USER_EMAIL not configured (optional)"
          else
            echo "âœ… JIRA_USER_EMAIL configured"
          fi
          
          # Create MCP config (even without secrets for testing)
          cat > ~/.copilot/mcp-config.json << 'EOF'
          {
            "mcpServers": {
              "atlassian": {
                "command": "npx",
                "args": [
                  "-y",
                  "@janhq/mcp-server-atlassian"
                ],
                "env": {
                  "JIRA_CLOUD_ID": "4c609fb1-ed57-4449-a5b4-d897fd7e3da8",
                  "JIRA_API_TOKEN": "${JIRA_API_TOKEN:-NOT_CONFIGURED}",
                  "JIRA_USER_EMAIL": "${JIRA_USER_EMAIL:-NOT_CONFIGURED}"
                }
              }
            }
          }
          EOF
          
          echo "âœ… MCP config created"
          cat ~/.copilot/mcp-config.json
          
      - name: Test - Run Copilot (Dry Run)
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_CLI_TOKEN }}
        run: |
          echo "ğŸ¤– Testing Copilot CLI execution..."
          
          if [ -z "$COPILOT_GITHUB_TOKEN" ]; then
            echo "âš ï¸ COPILOT_CLI_TOKEN not configured - skipping actual execution"
            echo "â„¹ï¸ To test execution, add COPILOT_CLI_TOKEN to repository secrets"
            exit 0
          fi
          
          # Create test prompt
          TEST_PROMPT="${{ github.event.inputs.test_prompt }}"
          
          echo "ğŸ“ Test prompt: $TEST_PROMPT"
          
          # Try running Copilot (will fail gracefully if not authenticated)
          echo "$TEST_PROMPT" | copilot --prompt "$(cat -)" --allow-all-tools --allow-all-paths < /dev/null \
            > test-output.log 2>&1 || true
          
          echo "ğŸ“„ Copilot output:"
          cat test-output.log
          
      - name: Test Summary
        if: always()
        run: |
          echo "ğŸ“Š Test Summary"
          echo "==============="
          echo ""
          echo "Components tested:"
          echo "- âœ… npm installation"
          echo "- âœ… Copilot CLI availability"
          echo "- âœ… Agent file existence"
          echo "- âœ… MCP configuration"
          echo "- ğŸ”‘ Copilot execution (requires COPILOT_CLI_TOKEN)"
          echo ""
          echo "ğŸ” Required Secrets (check repository settings):"
          echo "- COPILOT_CLI_TOKEN: ${{ secrets.COPILOT_CLI_TOKEN != '' && 'âœ… Configured' || 'âŒ Not configured' }}"
          echo "- JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN != '' && 'âœ… Configured' || 'âš ï¸ Optional' }}"
          echo "- JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL != '' && 'âœ… Configured' || 'âš ï¸ Optional' }}"
          
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: copilot-test-output
          path: |
            test-output.log
            ~/.copilot/mcp-config.json
          retention-days: 7
